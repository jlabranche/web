!function($){$.fn.board_task=function(task){return this.each(function(){function save_title(t){clearTimeout(t.data("save_timer")),encode_urls_emails(t);var e=task.title+"",r=t.html(),a=board.text().task_title_updated.sprintf(board.current_user().short_name,r);""!==e&&(a+=board.text().task_title_updated_previous.sprintf(e)),(""===r||r===e)&&(a=null),task.title=r,$task.trigger("save",{comment:a})}var $task=$(this);$(document).trigger("/task/added/",task),$task.timers=[];var $projects_dropdown=$(".project .list-group",$task),estimate_records_arr=records_by_position(board.estimate_records());$task.on("mouseenter",".task-id",function(){$(".task").not($task).removeClass("active"),$task.addClass("active")}),$task.on("mouseleave",".task-id",function(){$task.removeClass("active")}),$task.on("save",function(t,e){if(!current_user_has_cap("write"))return!1;"undefined"==typeof e&&(e=[]);var r={task:task};r.action="save_task",r.kanban_nonce=$("#kanban_nonce").val(),"undefined"!=typeof e.comment&&null!==e.comment&&""!==e.comment&&(r.comment=e.comment),"undefined"!=typeof e.status_id_old&&(r.status_id_old=e.status_id_old),$.ajax({method:"POST",url:ajaxurl,data:r}).always(function(t){show_growl_msg(t)}),$(".col-tasks").matchHeight()}),$task.on("delete",function(){if(!current_user_has_cap("write"))return!1;var t={task:task};t.action="delete_task",t.kanban_nonce=$("#kanban_nonce").val(),t.comment=board.text().task_deleted.sprintf(board.current_user().short_name),$.ajax({method:"POST",url:ajaxurl,data:t}).done(function(){delete board.task_records[task.ID],$task.slideUp("fast",function(){$(document).trigger("/task/deleted/",task),$task.remove(),$(".col-tasks").matchHeight(),update_task_count()})}).always(function(t){show_growl_msg(t)})}),$task.on("add_project",function(){return current_user_has_cap("write")?void setTimeout(function(){var t=$(".project_title",$task),e=t.val();if("undefined"!=typeof e&&""!==e){var r=!0;for(var a in board.project_records){var s=board.project_records[a];if(e===s.title){r=!1;break}}if(r){var o={action:"save_project",post_type:"kanban_project",kanban_nonce:$("#kanban_nonce").val(),project:{title:e}};$.ajax({method:"POST",url:ajaxurl,data:o}).done(function(t){try{var e=board.text().task_added_to_project.sprintf(board.current_user().short_name,t.data.project.title);if("undefined"!=typeof board.project_records[task.project_id]){var r=board.project_records[task.project_id];e+=board.text().task_added_to_project_previous.sprintf(r.title)}}catch(a){var e=null}try{board.project_records[t.data.project.id]=t.data.project,task.project_id=t.data.project.id,$task.trigger("save",{comment:e}).trigger("populate_project")}catch(a){}}).always(function(t){show_growl_msg(t)})}}},500):!1}),$task.on("status_change",function(t,e){if(!current_user_has_cap("write"))return!1;var r=task.status_id+"",a=board.text().task_moved_to_status.sprintf(board.current_user().short_name,board.status_records()[e].title);if("undefined"!=typeof board.status_records()[r]){var s=board.status_records()[r];a+=board.text().task_moved_to_status_previous.sprintf(s.title)}task.status_id=e,$task.trigger("save",{comment:a,status_id_old:r}),$(".task-handle",$task).css({background:board.status_records()[e].color_hex}),update_task_count()});var log_work_hour=function(t){if(!current_user_has_cap("write"))return!1;var e={task:task};e.action="add_task_hour",e.kanban_nonce=$("#kanban_nonce").val(),e.operator=t,$.ajax({method:"POST",url:ajaxurl,data:e}).always(function(t){show_growl_msg(t)})};$task.on("click",".editable-input",function(){if(!current_user_has_cap("write"))return!1;var t=$(this);t.prop("readonly")&&($(".editable-input").not(t).prop("readonly",!0),t.data("orig",t.val()),t.prop("readonly",!1),setTimeout(function(){t.focus().trigger("click").select()},100))}),$task.on("keyup",".editable-input",function(t){var e=$(this);if(13!==t.keyCode||t.shiftKey||e.trigger("blur"),27===t.keyCode){var r=e.data("orig");e.val(r).prop("readonly",!0)}}),$task.on("blur",".editable-input",function(){var t=$(this);t.prop("readonly",!0)}),$task.on("click",".delete-task",function(){return $task.trigger("delete"),!1}),$(".task-title",$task).on("focus",function(t){if(!current_user_has_cap("write"))return!1;var e=$(this);return $(t.target).is("a")?!1:(e.data("orig",e.html()),void e.html(sanitizeString(e.html())))}),$(".task-title",$task).on("keydown",function(t){if(!current_user_has_cap("write"))return!1;var e=$(this);if(27===t.keyCode){var r=e.data("orig");return e.html(r),void e.blur()}13!==t.keyCode||t.shiftKey||e.blur()}),$(".task-title",$task).on("keyup",function(){if(!current_user_has_cap("write"))return!1;var t=$(this);clearTimeout(t.data("save_timer"));var e=setTimeout(function(){save_title(t)},3e3);t.data("save_timer",e)}),$(".task-title",$task).on("blur",function(){if(!current_user_has_cap("write"))return!1;var t=$(this);save_title(t),window.getSelection().removeAllRanges()}),$task.on("click",".dropdown-menu-allowed-users .btn",function(){var t=$(this),e=t.val(),r=board.text().task_assigned_to.sprintf(board.current_user().short_name,board.allowed_users()[e].short_name);if("undefined"!=typeof board.allowed_users()[task.user_id_assigned]){var a=board.allowed_users()[task.user_id_assigned];r+=board.text().task_assigned_to_previous.sprintf(a.short_name)}task.user_id_assigned=e,$task.trigger("save",{comment:r}),$task.trigger("populate_user")}),$task.on("click",".dropdown-menu-estimates .btn",function(){var t=$(this),e=t.val(),r=board.text().task_estimate_updated.sprintf(board.current_user().short_name,board.estimate_records()[e].title);if("undefined"!=typeof board.estimate_records()[task.estimate_id]){var a=board.estimate_records()[task.estimate_id];r+=board.text().task_estimate_updated_previous.sprintf(a.title)}task.estimate_id=e,$task.trigger("save",{comment:r}),$task.trigger("populate_estimate")}),$task.on("click",".btn-task-hours",function(){return $(".task-hours-operators",$task).toggleClass("active"),!1}),$task.on("click",".task-hours-operators .btn",function(){if(!current_user_has_cap("write"))return!1;var $btn=$(this),btn_val=$btn.val();if("+"!=btn_val.substring(0,1)&&"-"!=btn_val.substring(0,1))return!1;var operator=parseFloat(btn_val);if(isNaN(operator))return!1;var current=parseFloat(task.hour_count);return current=eval(current+operator),current=Math.round(1e3*current)/1e3,0>current?void(current=0):(task.hour_count=current,$task.trigger("populate_task_hours"),log_work_hour(operator),!1)}),$task.on("populate_project",function(){var t=board.project_records[task.project_id];"undefined"==typeof t&&(t={id:0,title:""}),$task.attr("data-project-id",t.id),$(".project_title",$task).val(t.title).attr("data-id",t.id)}).trigger("populate_project"),$task.on("keyup",".project_title",function(t){var e=$(this);if(13===t.keyCode)return void $task.trigger("projects_dropdown_hide");if(27===t.keyCode)return void $task.trigger("projects_dropdown_hide");$task.trigger("projects_dropdown_show"),$(".list-group-item",$task).remove();var r=e.val(),a=$.trim(r.toLowerCase());for(var s in board.project_records){var o=board.project_records[s],n=o.title,i=$.trim(n.toLowerCase());i.search(a)>-1&&$(t_card_projects_dropdown.render(o)).appendTo($projects_dropdown)}0===$(".list-group-item",$task).length&&$task.trigger("projects_dropdown_hide")}),$task.on("blur",".project_title",function(){var t=$(".btn-edit-projects",$task);if($last_clicked[0]===t[0]){var e=jQuery.Event("keyup");e.which=27,e.keyCode=27,$(this).trigger(e);var r=t.attr("data-target");$(r).modal("show")}else $task.trigger("add_project")}),$task.on("focus",".project_title",function(){if(!current_user_has_cap("write"))return!1;var t=$(this);t.trigger("keyup")}),$task.on("click",".project .list-group-item",function(){$task.trigger("projects_dropdown_hide");var t=$(this).attr("data-id");if("undefined"==typeof board.project_records[t])return!1;var e=board.project_records[t],r=board.text().task_added_to_project.sprintf(board.current_user().short_name,e.title);if("undefined"!=typeof board.project_records[task.project_id]){var a=board.project_records[task.project_id];r+=board.text().task_added_to_project_previous.sprintf(a.title)}task.project_id=t,$task.trigger("save",{comment:r}).trigger("populate_project")}),$task.on("click",".btn-edit-projects",function(){$task.trigger("projects_dropdown_hide")});var update_progress_bar=function(){var t=0;if("undefined"!=typeof task.estimate_id&&"undefined"!=typeof task.hour_count){var e=board.estimate_records()[task.estimate_id];"undefined"!=typeof e&&(t=100*parseFloat(task.hour_count)/parseFloat(e.hours))}var r="success";t>133?r="danger":t>100&&(r="warning"),t>100&&(t=100),$(".progress-bar",$task).css({width:t+"%"}).removeClass("progress-bar-success progress-bar-warning progress-bar-danger").addClass("progress-bar-"+r)};if(current_user_has_cap("write"))for(var i in estimate_records_arr){var estimate=estimate_records_arr[i],$estimate=$(t_card_estimates_dropdown.render(estimate));$(".dropdown-menu-estimates",$task).append($estimate)}if($task.on("populate_estimate",function(){var t=board.estimate_records()[task.estimate_id],e="--";"undefined"!=typeof t&&(e=t.title);var r={estimate:e},a=$(t_card_estimate.render(r));$(".btn-estimate",$task).replaceWith(a),update_progress_bar()}).trigger("populate_estimate"),current_user_has_cap("write"))for(var i in board.allowed_users()){var user=board.allowed_users()[i];if(user_has_cap("write",user)){var $user=$(t_card_users_dropdown.render(user));$(".dropdown-menu-allowed-users",$task).append($user)}}$task.on("populate_user",function(){var t;try{t=board.allowed_users()[task.user_id_assigned],$task.attr("data-assigned-to",task.user_id_assigned)}catch(e){}"undefined"==typeof t&&(t={short_name:"-- Assign --",initials:"--"});var r=$(t_card_user_assigned_to.render(t));$(".btn-assigned-to",$task).replaceWith(r)}).trigger("populate_user"),$task.on("populate_task_hours",function(){task.hour_count=parseFloat(task.hour_count),task.hour_count<0&&(task.hour_count=0);var t;t=format_hours(task.hour_count);var e={hour_count:t},r=$(t_card_task_hours.render(e));$(".btn-task-hours",$task).replaceWith(r),update_progress_bar()}).trigger("populate_task_hours"),$task.on("projects_dropdown_show",function(){$projects_dropdown.show(),$task.addClass("active")}),$task.on("projects_dropdown_hide",function(){$projects_dropdown.hide(),$task.removeClass("active")}),$(".col-assigned-to",$task).on("show.bs.dropdown",function(){$task.addClass("active")}),$(".col-assigned-to",$task).on("hide.bs.dropdown",function(){$task.removeClass("active")}),$(".col-estimate",$task).on("show.bs.dropdown",function(){$task.addClass("active")}),$(".col-estimate",$task).on("hide.bs.dropdown",function(){$task.removeClass("active")})})}}(jQuery);